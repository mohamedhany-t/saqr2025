npm
# نظام الصقر للخدمات اللوجستية | AlSaqr Logistics System

**الصقر للخدمات اللوجستية** هو نظام متكامل لإدارة عمليات الشحن والتوصيل، تم تصميمه ليكون سريعًا، فعالًا، وقابلًا للتطوير. يدعم النظام تعدد المستخدمين بأدوار وصلاحيات مختلفة، ويوفر مجموعة قوية من الأدوات التي تجعل إدارة الشحنات والحسابات المالية والفرق الميدانية عملية سهلة ومنظمة.

تم بناء النظام باستخدام أحدث التقنيات بما في ذلك **Next.js**, **Firebase**, **ShadCN UI**, و **Genkit** للقدرات الذكية.

---

## الميزات الرئيسية

### 1. **إدارة الشحنات المتقدمة**
- **إضافة وتعديل:** واجهة سهلة لإضافة شحنات جديدة أو تعديل الشحنات الحالية.
- **استيراد جماعي:** إمكانية استيراد مئات الشحنات دفعة واحدة من خلال ملف Excel، مع تحديث الشحنات الحالية تلقائيًا إذا كانت موجودة.
- **تحديثات جماعية:** تحديث حالة، أو تعيين مندوب/شركة لمجموعة من الشحنات المحددة بضغطة زر.
- **طباعة الملصقات:** طباعة ملصقات شحن (Labels) فردية أو جماعية تحتوي على QR Code لتسهيل تتبع وتحديث الشحنات.
- **فلترة وبحث:** نظام فلترة قوي للبحث عن الشحنات حسب (المحافظة، الشركة، المندوب، الحالة)، بالإضافة إلى بحث نصي سريع.
- **أرشفة الشحنات:** القدرة على أرشفة الشحنات المنتهية لتنظيف الواجهة الرئيسية وتنظيم الحسابات.

### 2. **نظام أدوار وصلاحيات متكامل (Roles System)**
النظام مبني على ثلاثة أدوار أساسية، لكل منها لوحة تحكم ومسؤوليات خاصة:
- **المسؤول (Admin):**
    - يمتلك رؤية كاملة على جميع الشحنات والمستخدمين والتقارير.
        - إدارة كاملة للمستخدمين (إضافة/تعديل/حذف المناديب والشركات).
            - إدارة مالية شاملة وتسوية حسابات المناديب والشركات.
                - الوصول إلى جميع التقارير وأدوات الذكاء الاصطناعي.
                - **الشركة (Company):**
                    - لوحة تحكم خاصة لعرض وإدارة شحناتها فقط.
                        - إمكانية إضافة أو استيراد شحناتها بنفسها.
                            - عرض إحصائيات وتقارير خاصة بها.
                                - التواصل المباشر مع المسؤول عبر نظام الدردشة.
                                - **المندوب (Courier):**
                                    - واجهة بسيطة وفعالة مصممة للاستخدام الميداني.
                                        - عرض الشحنات النشطة والمنتهية الخاصة به.
                                            - تحديث حالة الشحنات بسهولة (تم التسليم، مرتجع، مؤجل، إلخ).
                                                - عرض ملخص مالي لحساباته وعمولاته.
                                                    - التواصل مع المسؤول عبر الدردشة ومشاركة تقارير سريعة للشحنات عبر واتساب.
                                                    
                                                    ### 3. **إدارة مالية دقيقة (Financial Management)**
                                                    - **حسابات المناديب:**
                                                        - نظام آلي لحساب عمولة المندوب بناءً على حالة الشحنة (توصيل ناجح، مرتجع، إلخ).
                                                            - تسجيل الدفعات المستلمة من المناديب وتحديث رصيدهم المستحق تلقائيًا.
                                                                - أرشفة وتسوية الحسابات لتصفير رصيد المندوب وبدء دورة مالية جديدة.
                                                                - **حسابات الشركات:**
                                                                    - حساب آلي لعمولة النظام المستحقة على كل شحنة.
                                                                        - تسجيل الدفعات المرسلة للشركات لتسوية حساباتهم.
                                                                        - **كشوفات حسابات تفصيلية:** إمكانية عرض وطباعة كشف حساب تفصيلي لأي مندوب أو شركة، يوضح جميع الحركات المالية والرصيد التراكمي.
                                                                        
                                                                        ### 4. **أدوات الذكاء الاصطناعي والتشغيل الذكي**
                                                                        - **مساعد التعيين الذكي (AI Assignment):**
                                                                            - يستخدم الذكاء الاصطناعي لتحليل الشحنات غير المعينة واقتراح أفضل مندوب لكل شحنة بناءً على الموقع الجغرافي وعبء العمل الحالي لكل مندوب.
                                                                                - تنفيذ التعيينات المقترحة بضغطة زر واحدة.
                                                                                - **صندوق المشاكل (Problem Inbox):**
                                                                                    - واجهة مخصصة تعرض للمسؤول الشحنات التي تحتاج إلى تدخل فوري، مثل:
                                                                                            - المرتجعات التي تحتاج إلى قرار.
                                                                                                    - الشحنات المؤجلة لفترة طويلة.
                                                                                                            - الشحنات المتأخرة عند المناديب (التي لم يتم تحديث حالتها لأكثر من 24 ساعة).
                                                                                                            - **إشعارات وتنبيهات ذكية:**
                                                                                                                - يقوم النظام بإرسال تنبيهات تلقائية للمسؤول عند حدوث أمور هامة، مثل:
                                                                                                                        - تجاوز ديون مندوب معين لحد معين.
                                                                                                                                - وجود ضغط عمل كبير على مندوب.
                                                                                                                                        - ارتفاع معدل المرتجعات لشركة معينة.
                                                                                                                                        
                                                                                                                                        ### 5. **تواصل وتقارير متقدمة**
                                                                                                                                        - **نظام الدردشة المدمج:**
                                                                                                                                            - تواصل فوري وآمن بين المسؤول والمناديب والشركات.
                                                                                                                                                - إشعارات فورية (Push Notifications) عند وصول رسائل جديدة.
                                                                                                                                                    - دعم إرسال الصور والملفات.
                                                                                                                                                    - **نظام تقارير شامل:**
                                                                                                                                                        - إمكانية إنشاء وتصدير تقارير Excel مخصصة، مثل:
                                                                                                                                                                - تقرير الشحنات الكامل أو حسب الحالة (تسليمات، مرتجعات).
                                                                                                                                                                        - التقارير المالية للمناديب والشركات.
                                                                                                                                                                                - شيتات توريد مخصصة للشركات أو المناديب بناءً على فلاتر محددة.
                                                                                                                                                                                
                                                                                                                                                                                ### 6. **تجربة استخدام محسّنة (UX & Mobility)**
                                                                                                                                                                                - **تطبيق ويب تقدمي (PWA):** يمكن تثبيت النظام على أي جهاز (كمبيوتر أو موبايل) كتطبيق أصلي للوصول السريع وتلقي الإشعارات.
                                                                                                                                                                                - **واجهة متجاوبة:** تصميم متكامل يعمل بكفاءة على شاشات الكمبيوتر والموبايل.
                                                                                                                                                                                - **دعم التحديث الجماعي على الموبايل:** تمكين المستخدمين من تحديد وتحديث مجموعة من الشحنات دفعة واحدة من هواتفهم.
                                                                                                                                                                                - **إشعارات صوتية:** تنبيهات صوتية عند وصول رسائل جديدة لضمان عدم تفويت أي تحديث مهم.

---

## خطوات النشر على Firebase App Hosting (لضمان عمل الإشعارات)

عند نشر هذا التطبيق على Firebase App Hosting، يتم التعامل مع مفاتيح الخدمة (Service Account Keys) تلقائيًا. ولكن، يجب تكوين مفاتيح VAPID يدويًا لكي تعمل إشعارات الويب (Push Notifications).

اتبع هذه الخطوات **بعد** نشر التطبيق لأول مرة:

### الخطوة 1: تفعيل الخدمات المطلوبة

1.  اذهب إلى [Google Cloud Console](https://console.cloud.google.com/) وتأكد من أنك في المشروع الصحيح المرتبط بـ Firebase.
2.  ابحث عن "Secret Manager API" في شريط البحث وقم بتفعيله (Enable).
3.  ابحث عن "Cloud Run API" وقم بتفعيله أيضًا إذا لم يكن مفعلًا.

### الخطوة 2: إضافة مفاتيح VAPID إلى Secret Manager

ستحتاج إلى إضافة مفتاحين سريين (Secrets) لمفاتيح VAPID العامة والخاصة.

**للمفتاح الخاص (VAPID_PRIVATE_KEY):**

1.  اذهب إلى [صفحة Secret Manager](https://console.cloud.google.com/security/secret-manager).
2.  انقر على **Create Secret**.
3.  **Name:** أدخل `VAPID_PRIVATE_KEY`. (الاسم مهم جدًا)
4.  **Secret value:** الصق قيمة المفتاح الخاص الموجودة في ملف `.env` المحلي.
5.  **Regions:** اتركها تلقائية (Automatic).
6.  انقر على **Create Secret**.

**للمفتاح العام (NEXT_PUBLIC_VAPID_PUBLIC_KEY):**

1.  كرر نفس الخطوات: انقر على **Create Secret**.
2.  **Name:** أدخل `NEXT_PUBLIC_VAPID_PUBLIC_KEY`. (الاسم مهم)
3.  **Secret value:** الصق قيمة المفتاح العام الموجودة في ملف `.env` المحلي.
4.  **Regions:** اتركها تلقائية.
5.  انقر على **Create Secret**.

### الخطوة 3: ربط الأسرار (Secrets) بخدمة Cloud Run

يقوم Firebase App Hosting بتشغيل الـ Backend الخاص بك كخدمة Cloud Run. تحتاج إلى منح هذه الخدمة صلاحية الوصول إلى الأسرار التي أنشأتها.

1.  اذهب إلى [صفحة Cloud Run](https://console.cloud.google.com/run).
2.  ابحث عن الخدمة التي تم إنشاؤها لتطبيقك. غالبًا ما يكون اسمها شيئًا مثل `apphosting-...` أو اسم مشابه. انقر عليها.
3.  انقر على **Edit & Deploy New Revision**.
4.  اذهب إلى تبويب **Variables & Secrets**.
5.  تحت قسم **Secrets**، انقر على **Reference a secret**.
    *   **Secret:** اختر `VAPID_PRIVATE_KEY` الذي أنشأته.
    *   **Reference method:** اختر **Exposed as environment variable**.
    *   **Name:** أدخل `VAPID_PRIVATE_KEY`.
    *   انقر **Done**.
6.  كرر الخطوة السابقة لربط المفتاح العام:
    *   انقر على **Reference a secret** مرة أخرى.
    *   **Secret:** اختر `NEXT_PUBLIC_VAPID_PUBLIC_KEY`.
    *   **Reference method:** اختر **Exposed as environment variable**.
    *   **Name:** أدخل `NEXT_PUBLIC_VAPID_PUBLIC_KEY`.
    *   انقر **Done**.
7.  أخيرًا، انقر على **Deploy**.

بعد اكتمال عملية النشر الجديدة (قد تستغرق دقيقة أو دقيقتين)، ستكون الإشعارات جاهزة للعمل في بيئة الإنتاج.
