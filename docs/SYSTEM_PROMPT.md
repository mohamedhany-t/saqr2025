# Prompt تفصيلي لنظام الصقر للخدمات اللوجستية (AlSaqr Logistics System)

## 1. نظرة عامة على المشروع

**اسم المشروع:** نظام الصقر للخدمات اللوجستية | AlSaqr Logistics System

**الغرض الأساسي:** هو نظام متكامل لإدارة عمليات الشحن والتوصيل، مصمم ليكون سريعًا، فعالًا، وقابلًا للتطوير. يدعم النظام تعدد المستخدمين بأدوار وصلاحيات مختلفة، ويوفر مجموعة قوية من الأدوات التي تجعل إدارة الشحنات، الحسابات المالية، والفرق الميدانية عملية سهلة ومنظمة.

**المبدأ الأساسي للتصميم:** النظام عبارة عن تطبيق ويب يعمل في الوقت الفعلي (Real-time). أي تغيير يحدث من قبل أي مستخدم (مثل تحديث حالة شحنة) يجب أن يظهر فورًا لدى جميع المستخدمين الآخرين الذين لديهم صلاحية رؤية هذا التغيير دون الحاجة لتحديث الصفحة.

---

## 2. نماذج البيانات الأساسية (Core Data Models)

هذه هي الكيانات الرئيسية في قاعدة البيانات (قاعدة بيانات NoSQL):

### أ. `users` (المستخدمون)
- **الوصف:** يخزن معلومات جميع المستخدمين في النظام.
- **الحقول:**
  - `id` (string): معرف فريد للمستخدم (UID).
  - `name` (string): اسم المستخدم (أو اسم الشركة).
  - `email` (string): البريد الإلكتروني (يستخدم لتسجيل الدخول).
  - `role` (string): دور المستخدم (`admin`, `company`, `courier`).
  - `companyId` (string): (اختياري) يربط المندوب بشركة معينة.
  - `createdAt` (Timestamp): تاريخ إنشاء الحساب.
  - `commissionRate` (number): (خاص بالمناديب) عمولة ثابتة لكل شحنة ناجحة أو مرتجعة.

### ب. `shipments` (الشحنات)
- **الوصف:** يمثل سجلات الشحنات الفردية.
- **الحقول:**
  - `id` (string): معرف فريد للشحنة.
  - `shipmentCode` (string): كود فريد للشحنة (مثال: `SH-20240728-0001`).
  - `orderNumber` (string): رقم الطلب الخاص بالعميل.
  - `trackingNumber` (string): رقم التتبع.
  - `recipientName` (string): اسم المستلم.
  - `recipientPhone` (string): هاتف المستلم.
  - `governorateId` (string): معرّف المحافظة.
  - `address` (string): عنوان المستلم التفصيلي.
  - `status` (string): حالة الشحنة الحالية (قائمة الحالات أدناه).
  - `totalAmount` (number): المبلغ الإجمالي المطلوب تحصيله.
  - `paidAmount` (number): المبلغ الذي تم تحصيله بالفعل.
  - `courierCommission` (number): عمولة المندوب المحسوبة لهذه الشحنة.
  - `companyCommission` (number): عمولة النظام المحسوبة على الشركة لهذه الشحنة.
  - `companyId` (string): معرّف الشركة (العميل الرئيسي) المالكة للشحنة.
  - `assignedCourierId` (string): معرّف المندوب المكلف بالشحنة.
  - `isArchivedForCourier` (boolean): علامة لأرشفة الشحنة من حساب المندوب بعد التسوية.
  - `isArchivedForCompany` (boolean): علامة لأرشفة الشحنة من حساب الشركة بعد التسوية.
  - `createdAt`, `updatedAt` (Timestamp): تواريخ إنشاء وتحديث الشحنة.

### ج. `companies` (الشركات)
- **الوصف:** يخزن معلومات الشركات (العملاء الرئيسيين).
- **الحقول:**
  - `id` (string): المعرف الفريد (نفس UID المستخدم).
  - `name` (string): اسم الشركة.
  - `governorateCommissions` (map): خريطة تحتوي على عمولات النظام لكل محافظة (مثال: `{ "gov_cairo": 5, "gov_giza": 7 }`).

### د. `couriers` (المناديب)
- **الوصف:** يخزن معلومات المناديب.
- **الحقول:**
  - `id` (string): المعرف الفريد (نفس UID المستخدم).
  - `name` (string): اسم المندوب.
  - `commissionRate` (number): العمولة الثابتة لكل شحنة ناجحة أو مرتجعة.

### هـ. `governorates` (المحافظات)
- **الوصف:** قائمة المحافظات المتاحة في النظام.
- **الحقول:**
  - `id` (string): معرف فريد.
  - `name` (string): اسم المحافظة (باللغة العربية).

### و. المدفوعات (`courier_payments`, `company_payments`)
- **الوصف:** سجلات لجميع الدفعات المالية التي تتم لتسوية الحسابات.
- **الحقول:**
  - `id` (string): معرف فريد لعملية الدفع.
  - `courierId` / `companyId` (string): معرّف المندوب أو الشركة.
  - `amount` (number): المبلغ المدفوع.
  - `paymentDate` (Timestamp): تاريخ تسجيل الدفعة.
  - `recordedById` (string): معرّف المسؤول الذي سجل الدفعة.
  - `isArchived` (boolean): علامة لأرشفة الدفعات بعد التسوية الكاملة.

---

## 3. الأدوار والوظائف (Roles & Functionality)

### أ. المسؤول (Admin)
- **الوصول:** يرى كل شيء في النظام.
- **الوظائف:**
  - **إدارة المستخدمين:**
    - **الزر:** "إضافة مستخدم" في تبويب "إدارة المستخدمين".
    - **الإجراء:** يفتح نموذجًا لإنشاء مستخدم جديد (مندوب، شركة، أو مسؤول آخر) مع تحديد اسمه وبريده الإلكتروني وكلمة المرور وعمولته (إذا كان مندوبًا) أو عمولات المحافظات (إذا كانت شركة).
    - **الأثر:** يتم إنشاء حساب للمستخدم في نظام المصادقة، وسجل في `users`، وسجل مطابق في `couriers` أو `companies`.
  - **إدارة الشحنات:**
    - **الزر:** "شحنة جديدة".
    - **الإجراء:** يفتح نموذجًا لإدخال جميع تفاصيل الشحنة يدويًا.
    - **الزر:** "استيراد".
    - **الإجراء:** يفتح نافذة لاختيار ملف Excel. عند اختيار الملف، يقوم النظام بقراءة البيانات وتحديث الشحنات الموجودة (بنفس رقم التتبع) أو إضافة شحنات جديدة. يعرض النظام ملخصًا للعملية (كم عدد الشحنات التي تم إضافتها وتحديثها).
    - **أزرار التحديث الجماعي:** تظهر عند تحديد شحنات متعددة في الجدول. تسمح بتغيير (الحالة، المندوب، الشركة) لمجموعة من الشحنات بضغطة زر.
  - **الإدارة المالية:**
    - **التبويب:** "إدارة المناديب" / "إدارة الشركات".
    - **الإجراء:** يعرض بطاقات لكل مندوب/شركة مع ملخص مالي (المبلغ المستحق عليهم أو لهم).
    - **الزر:** "تسوية الحساب" على بطاقة المندوب/الشركة.
    - **الإجراء:** يفتح نموذجًا لإدخال مبلغ تم دفعه (من المندوب أو إلى الشركة)، ويتم تسجيله في `courier_payments` أو `company_payments`.
    - **الزر:** "أرشفة وتسوية الكل".
    - **الإجراء:** يقوم بتسوية الحساب بالكامل (يسجل دفعة بالمبلغ المتبقي)، ثم يخفي جميع الشحنات والدفعات المنتهية من الحسابات النشطة عن طريق تفعيل علامة `isArchived`.
  - **الذكاء الاصطناعي:**
    - **التبويب:** "الذكاء الاصطناعي".
    - **الإجراء:** يعرض صفحة "مساعد التعيين الذكي" التي تحتوي على قائمة بالشحنات غير المعينة وقائمة بالمناديب المتاحين.
    - **الزر:** "اقتراح التوزيع".
    - **الإجراء:** يرسل بيانات الشحنات والمناديب إلى نموذج الذكاء الاصطناعي، الذي يعود بقائمة من التعيينات المقترحة مع سبب كل اقتراح.
    - **الزر:** "تنفيذ التعيينات".
    - **الإجراء:** يقوم بتحديث حقل `assignedCourierId` في جميع الشحنات المقترحة دفعة واحدة.
  - **صندوق المشاكل:**
    - **التبويب:** "صندوق المشاكل".
    - **الإجراء:** يعرض قوائم بالشحنات التي تحتاج إلى تدخل فوري، مثل: المرتجعات التي لم يتم تحديد مصيرها، الشحنات المؤجلة لفترة طويلة، أو الشحنات التي لم يتم تحديث حالتها منذ أكثر من 24 ساعة.

### ب. الشركة (Company)
- **الوصول:** ترى شحناتها الخاصة فقط.
- **الوظائف:**
  - **إدارة الشحنات:**
    - **الأزرار:** "شحنة جديدة" و "استيراد" تعمل بنفس طريقة المسؤول، ولكن يتم تعيين `companyId` تلقائيًا إلى `id` الشركة الحالية.
    - **تعديل الشحنة:** يمكن للشركة تعديل تفاصيل الشحنة طالما أنها لم تُعين لمندوب بعد. بعد التعيين، يتم قفل معظم الحقول.
    - **تعيين مندوب:** يمكن للشركة اختيار مندوب متاح من قائمة منسدلة وتعيين الشحنة له.
  - **التقارير:** ترى إحصائيات وملخصات مالية خاصة بشحناتها فقط.
  - **التواصل:** يمكنها بدء محادثة مع المسؤول فقط.

### ج. المندوب (Courier)
- **الوصول:** يرى الشحنات المُعينة له فقط والتي لم تتم أرشفتها.
- **الوظائف:**
  - **تحديث حالة الشحنة:**
    - **الزر:** "تعديل" على بطاقة الشحنة.
    - **الإجراء:** يفتح نموذجًا مبسطًا يسمح له فقط بتغيير حقل `status` (الحالة) وإضافة `reason` (سبب/ملاحظة). إذا كانت الحالة "تسليم جزئي"، يظهر حقل إضافي لإدخال `collectedAmount` (المبلغ المحصَّل).
    - **الأثر:** عند الحفظ، يتم تحديث الشحنة، ويقوم النظام تلقائيًا بإعادة حساب `paidAmount` و `courierCommission`.
  - **عرض الحسابات:**
    - **التبويب:** "الحسابات".
    - **الإجراء:** يعرض ملخصًا ماليًا بسيطًا: إجمالي ما قام بتحصيله، إجمالي عمولاته، إجمالي ما قام بتسليمه للشركة، والصافي المستحق عليه.
  - **التواصل:** يمكنه بدء محادثة مع المسؤول فقط.
  - **المشاركة عبر واتساب:**
    - **الزر:** "مشاركة" على بطاقة الشحنة.
    - **الإجراء:** يقوم بإنشاء رسالة واتساب منسقة تحتوي على تفاصيل الشحنة (اسم العميل، العنوان، المبلغ) لإرسالها للعميل أو للمسؤول.

---

## 4. قواعد العمل الهامة (Business Logic Rules)

- **حساب العمولات (Rule of Commission Calculation):**
  - **المتغيرات:** `totalAmount`, `collectedAmount`, `courierCommissionRate`, `companyCommissionRate`.
  - **القاعدة:** يتم تفعيل حساب العمولات فقط عند تغيير `status` الشحنة إلى حالة نهائية تؤثر على الماليات.
    - `Delivered`: `paidAmount` = `totalAmount`. يتم احتساب عمولة المندوب والشركة.
    - `Partially Delivered` / `Refused (Paid)`: `paidAmount` = `collectedAmount`. يتم احتساب عمولة المندوب والشركة.
    - `Evasion (Delivery Attempt)` / `Refused (Unpaid)`: يتم احتساب عمولة المendوب فقط. `paidAmount` = 0.
    - أي حالة أخرى (مثل `Pending`, `Cancelled`): يتم تصفير جميع الحقول المالية (`paidAmount`, `courierCommission`, `companyCommission`) إلى 0.
- **الأرشفة والتسوية (Rule of Archiving & Settlement):**
  - عند أرشفة حساب (مندوب أو شركة)، يقوم النظام بتسجيل دفعة تسوية تلقائية بالمبلغ المتبقي لجعل الرصيد صفرًا.
  - بعد ذلك، يتم تفعيل علامة `isArchived` على جميع الشحنات والدفعات المنتهية المتعلقة بهذا الحساب، مما يؤدي إلى إخفائها من الواجهات النشطة.
- **الصلاحيات (Rule of Permissions):** المبدأ الأساسي هو "التقييد". لا يُسمح لأي دور بالوصول إلى بيانات أو وظائف لا يحتاجها بشكل مباشر. المسؤول هو الاستثناء الوحيد.
- **الاستيراد (Rule of Import):** عند استيراد ملف Excel، يتم استخدام "رقم التتبع" (`trackingNumber`) كمعرف فريد. إذا كان موجودًا بالفعل، يتم تحديث بيانات الشحنة. إذا لم يكن موجودًا، يتم إنشاء شحنة جديدة.

هذا الوصف يوفر فهمًا عميقًا للنظام من الناحية الوظيفية، مما يمكّن أي مطور أو ذكاء اصطناعي من فهم البنية الحالية والبناء عليها بفعالية.
